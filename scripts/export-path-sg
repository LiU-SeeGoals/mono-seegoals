#!/bin/bash

bin_path="$(pwd)/bin"
completions_path="$(pwd)/completions"

echo -e "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "📝 To install completions system-wide, run:"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [[ -f "$completions_path/sg-fw-completion.bash" ]]; then
    echo -e "\n🐚 For Bash:"
    echo -e "  sudo cp $completions_path/sg-fw-completion.bash /etc/bash_completion.d/"
    echo -e "  OR (if on macOS with Homebrew):"
    echo -e "  cp $completions_path/sg-fw-completion.bash /usr/local/etc/bash_completion.d/"
fi

if [[ -f "$completions_path/_sg-fw" ]]; then
    echo -e "\n🚀 For Zsh:"
    echo -e "  sudo cp $completions_path/_sg-fw /usr/share/zsh/site-functions/"
    echo -e "  OR (if on macOS with Homebrew):"
    echo -e "  cp $completions_path/_sg-fw /usr/local/share/zsh/site-functions/"
fi


if echo "$PATH" | grep -q "$bin_path"; then
    echo -e "\nThe path \"$bin_path\" already in \$PATH:\n"
    echo "$PATH"
    exit 0
fi

echo "This script will back up your old ~/.*rc file and add a new \$PATH to it."
read -p "Are you sure '$bin_path' is the correct path to add to \$PATH? (y/n): " confirm

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Exiting..."
    exit 1
fi

echo "Adding SeeGoals bin folder to paths..."

update_path_in_file() {
    local file=$1
    if test -f "$file"; then
        if grep -q "$bin_path" "$file"; then
            echo -e "\t$bin_path is already in $file"
        else
            echo -e "\tBacking up to $file.bak and replacing the export PATH line..."
            cp "$file" "$file.bak"
            echo "export PATH=\"\$PATH:$bin_path\"" >> "$file"

            # Only add fpath for zsh
            if [[ "$file" == *".zshrc" ]]; then
                echo "fpath=(\$fpath $completions_path)" >> "$file"
            fi

            echo -e "\tAdded export PATH in $file"
        fi
    else
        echo -e "\t$file does not exist"
    fi
}

update_path_in_file "$HOME/.bashrc"
update_path_in_file "$HOME/.zshrc"

echo -e "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "✅ PATH setup complete! Reload your shell with: exec \$SHELL"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
